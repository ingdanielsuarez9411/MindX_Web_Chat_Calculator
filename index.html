<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget de Asistente Virtual en AXD.COM.CO</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === ESTILOS DE LA P√ÅGINA PRINCIPAL Y EL MODAL (Sin cambios) === */
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Montserrat', sans-serif;
        }
        #site-iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 1;
        }
        
        @keyframes pulseAnimation {
            0% { transform: scale(1); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
            50% { transform: scale(1.05); box-shadow: 0 12px 40px rgba(0,0,0,0.3); }
            100% { transform: scale(1); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        }

        #widget-trigger {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 100%);
            border-radius: 50%; cursor: pointer; z-index: 998; display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s ease;
            animation: pulseAnimation 2.5s infinite ease-in-out;
        }
        #widget-trigger:hover {
            animation-play-state: paused;
            transform: scale(1.1)!important; 
        }
        #widget-trigger img {
            width: 35px; height: auto;
        }

        #proactive-message {
            position: fixed;
            bottom: 35px;
            right: 100px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 997;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
        }
        #proactive-message.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #proactive-message::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0; 
            height: 0; 
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid #b8941f;
        }
        
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6);
            z-index: 999; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.4s ease;
        }
        #modal-overlay.visible {
            display: flex; opacity: 1;
        }
        #modal-content {
            position: relative; width: 90%; height: 90%; max-width: 420px; max-height: 750px; background: #fff;
            border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.4s ease;
        }
        #modal-overlay.visible #modal-content {
            transform: scale(1);
        }
        
        /* === ESTILOS DE LA CALCULADORA Y CHAT === */
        * {
            margin: 0; padding: 0; box-sizing: border-box;
        }
        .chat-container {
            width: 100%; height: 100%; background: white; display: flex; flex-direction: column;
            overflow: hidden; position: relative; font-family: 'Montserrat', sans-serif;
        }
        .chat-header {
            background: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 100%); padding: 15px 20px; color: white;
            display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative; flex-shrink: 0;
        }
        .close-btn {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none;
            color: #ccc; font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.2s ease;
        }
        .close-btn:hover {
            background: rgba(255,255,255,0.1); color: white;
        }
        .avatar {
            width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #d4af37, #b8941f);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white;
            flex-shrink: 0; overflow: hidden;
        }
        .avatar img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
        }
        .header-info {
            flex-grow: 1;
        }
        .header-info h1 {
            font-size: 1.1rem; font-weight: 700; color: #d4af37; margin-bottom: 2px;
        }
        .header-info p {
            font-size: 0.8rem; color: #cccccc; opacity: 0.9;
        }
        .chat-messages {
            flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column;
            gap: 12px; background: #fafafa;
        }
        .message {
            display: flex; gap: 10px; animation: slideInUp 0.3s ease; max-width: 95%;
        }
        .message.user {
            flex-direction: row-reverse; align-self: flex-end;
        }
        .message.assistant {
            align-self: flex-start;
        }
        .message-avatar {
            width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center; font-size: 0.9rem; color: white;
            font-weight: 600; overflow: hidden;
        }
        .message-avatar img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
        }
        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #d4af37, #b8941f);
        }
        .message.user .message-avatar {
            background: linear-gradient(135deg, #2c2c2c, #3a3a3a);
        }
        .message-content {
            background: white; padding: 10px 14px; border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative;
        }
        .message.user .message-content {
            background: linear-gradient(135deg, #d4af37, #b8941f); color: white;
        }
        .message-content p {
            margin: 0; line-height: 1.4; font-size: 0.85rem;
        }
        
        .chat-input-area {
            flex-shrink: 0; padding: 10px 15px; background: #ffffff;
            border-top: 1px solid #e0e0e0; display: flex; align-items: center; gap: 10px;
        }
        #userInput {
            flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px;
            background: #f0f2f5; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;
            outline: none; transition: background 0.3s;
        }
        #userInput:focus {
            background: #e9e9e9;
        }
        .input-button {
            background: none; border: none; cursor: pointer; font-size: 1.2rem;
            color: #888; transition: color 0.3s;
        }
        .input-button:hover {
            color: #d4af37;
        }
        #sendMessageBtn {
            background: linear-gradient(135deg, #d4af37, #b8941f); color: white;
            border-radius: 50%; width: 40px; height: 40px; display: flex;
            align-items: center; justify-content: center; font-size: 1rem;
        }
        #sendMessageBtn:hover {
             box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        
        /* === ESTILOS ORIGINALES DE BOTONES (Sin cambios) === */
        .button-options{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}.option-button{background:linear-gradient(135deg,#f8f9fa,#e9ecef);border:2px solid #d4af37;color:#2c2c2c;padding:6px 12px;border-radius:15px;font-family:'Montserrat',sans-serif;font-weight:600;font-size:.75rem;cursor:pointer;transition:all .3s ease;white-space:nowrap}.option-button:hover{background:linear-gradient(135deg,#d4af37,#b8941f);color:#fff;transform:translateY(-2px);box-shadow:0 4px 15px rgba(212,175,55,.3)}.option-button.selected{background:linear-gradient(135deg,#d4af37,#b8941f);color:#fff}.quantity-selector{display:flex;align-items:center;gap:8px;margin-top:8px;padding:8px;background:#f8f9fa;border-radius:10px;border:1px solid #dee2e6}.quantity-btn{width:25px;height:25px;border:none;border-radius:50%;background:#d4af37;color:#fff;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;font-size:.8rem}.quantity-btn:hover{background:#b8941f;transform:scale(1.1)}.quantity-display{font-weight:700;font-size:.9rem;color:#2c2c2c;min-width:30px;text-align:center}.continue-button{background:linear-gradient(135deg,#d4af37,#b8941f);color:#fff;border:none;padding:8px 16px;border-radius:20px;font-family:'Montserrat',sans-serif;font-weight:700;font-size:.8rem;cursor:pointer;margin-top:10px;transition:all .3s ease;align-self:flex-start}.continue-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(212,175,55,.4)}.cost-display{background:linear-gradient(135deg,#2c2c2c,#3a3a3a);color:#d4af37;padding:12px;border-radius:10px;margin-top:8px;font-weight:700;text-align:center;font-size:.9rem}.summary-table{background:#fff;border-radius:10px;overflow:hidden;margin-top:12px;box-shadow:0 4px 15px rgba(0,0,0,.1)}.summary-row{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #f0f0f0;font-size:.8rem}.summary-row:last-child{border-bottom:none;background:linear-gradient(135deg,#d4af37,#b8941f);color:#fff;font-weight:700}.progress-bar{height:3px;background:#e0e0e0;position:absolute;top:0;left:0;right:0}.progress-fill{height:100%;background:linear-gradient(90deg,#d4af37,#b8941f);transition:width .5s ease;width:0%}
        
        /* === INICIO: NUEVOS ESTILOS PARA TARJETAS DE IMPLEMENTACI√ìN === */
        .implementation-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
        .implementation-card{background:#fff;border:2px solid #e0e0e0;border-radius:15px;padding:12px;text-align:center;cursor:pointer;transition:all .3s ease; display: flex; flex-direction: column; justify-content: space-between; height: 100%;}
        .implementation-card:hover{border-color:#d4af37;transform:translateY(-2px);box-shadow:0 6px 20px rgba(212,175,55,.2)}
        .implementation-card.selected{border-color:#d4af37;background:linear-gradient(135deg,#fffbe6,#fff9d6); box-shadow:0 6px 20px rgba(212,175,55,.2);}
        .card-icon{font-size:1.8rem;margin-bottom:5px; color: #007bff;}
        .card-title{font-weight:700;color:#2c2c2c;margin-bottom:3px;font-size:.9rem}
        .card-subtitle{color:#666;font-size:.75rem;margin-bottom:5px}
        .card-price{font-size:1.1rem;font-weight:700;color:#d4af37;margin-bottom:0}
        .card-hours{color:#888;font-size:.7rem; margin-bottom: 10px;}
        .card-features {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            text-align: left;
            font-size: 0.75rem;
            color: #555;
        }
        .card-features li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .card-features .fas {
            color: #28a745;
            margin-right: 6px;
            margin-top: 2px;
        }
        /* === FIN: NUEVOS ESTILOS === */

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #b8941f; }
    </style>
</head>
<body>

    <iframe id="site-iframe" src="https://axd.com.co" title="AXD.COM.CO"></iframe>

    <div id="widget-trigger">
        <img src="https://cdn3d.iconscout.com/3d/premium/thumb/asistente-robot-8137090-6617492.png" alt="Abrir Asistente">
    </div>
    <div id="proactive-message">¬øtienes dudas? ¬°preguntame!</div>

    <div id="modal-overlay">
        <div id="modal-content">
            <div class="chat-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="chat-header">
                    <div class="avatar">
                        <img src="https://cdn3d.iconscout.com/3d/premium/thumb/asistente-robot-8137090-6617492.png" alt="MindX AI" />
                    </div>
                    <div class="header-info">
                        <h1 id="chat-title">Asistente Virtual</h1>
                        <p>AXD - Canales Digitales</p>
                    </div>
                    <button class="close-btn" onclick="closeCalculator()">&times;</button>
                </div>

                <div class="chat-messages" id="chatMessages"></div>
                
                <div class="chat-input-area">
                    <button class="input-button" id="attachFileBtn"><i class="fas fa-paperclip"></i></button>
                    <button class="input-button" id="emojiPickerBtn"><i class="far fa-smile"></i></button>
                    <input type="text" id="userInput" placeholder="Escribe tu mensaje...">
                    <button class="input-button" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>


    <script>
    // === SCRIPT PARA CONTROLAR EL MODAL Y EL WIDGET ===
    const widgetTrigger = document.getElementById('widget-trigger');
    const modalOverlay = document.getElementById('modal-overlay');
    const proactiveMessage = document.getElementById('proactive-message');

    widgetTrigger.addEventListener('click', () => {
        proactiveMessage.classList.remove('visible');
        modalOverlay.classList.add('visible');
        if (!window.calculator || window.calculator.isFinished) {
            window.calculator = new AICostCalculator();
        }
    });

    modalOverlay.addEventListener('click', (event) => {
        if (event.target === modalOverlay) modalOverlay.classList.remove('visible');
    });

    window.addEventListener('message', (event) => {
        if (event.data === 'closeCalculator') {
            modalOverlay.classList.remove('visible');
        } else if (event.data === 'contactSales') {
            modalOverlay.classList.remove('visible');
            alert('Gracias por tu inter√©s. Un especialista de AXD te contactar√° pronto.');
        }
    });

    function closeCalculator() {
        window.parent.postMessage('closeCalculator', '*');
    }

    class AICostCalculator {
        constructor() {
            // ... (El constructor se mantiene igual) ...
             this.flowState = 'ASK_PRODUCT';
            this.leadData = {};
            this.isFinished = false;
            this.step = 0;
            this.totalSteps = 8;
            this.data = {
                channels: [], package: null, additionalConversations: 0, additionalInsights: 0, agentLicenses: 0,
                includeAI: false, aiConfig: {}, notifications: { marketing: 0, utility: 0, authentication: 0 },
                implementation: null, trm: 4200
            };
            this.costs = {
                channels: 0, package: 0, insights: 0, agents: 0,
                ai: { loading: 0, storage: 0, usage: 0, monthly: 0 },
                notifications: 0, implementation: 0
            };
            this.messagesContainer = document.getElementById('chatMessages');
            this.userInput = document.getElementById('userInput');
            this.sendMessageBtn = document.getElementById('sendMessageBtn');
            this.attachFileBtn = document.getElementById('attachFileBtn');
            this.emojiPickerBtn = document.getElementById('emojiPickerBtn');
            this.chatTitle = document.getElementById('chat-title');
            this.init();
        }

        init() {
             // ... (Init se mantiene igual) ...
            this.messagesContainer.innerHTML = '';
            this.setupInputHandlers();
            this.askProduct();
        }

        setupInputHandlers() {
            // ... (setupInputHandlers se mantiene igual) ...
            this.sendMessageBtn.onclick = () => this.handleUserInput();
            this.userInput.onkeydown = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.handleUserInput();
                }
            };
            this.attachFileBtn.onclick = () => alert('Funci√≥n para adjuntar archivos no implementada.');
            this.emojiPickerBtn.onclick = () => alert('Selector de emojis no implementado.');
        }

        async handleUserInput() {
            // ... (handleUserInput se mantiene igual) ...
            const text = this.userInput.value.trim();
            if (!text) return;
            await this.addMessage(`<p>${text}</p>`, true);
            this.userInput.value = '';
            this.processInput(text);
        }

        async processInput(text) {
            // ... (processInput se mantiene igual) ...
            const normalizedText = text.toLowerCase().replace(/\s+/g, '');
            switch (this.flowState) {
                case 'ASK_PRODUCT':
                    if (normalizedText.includes('mindx')) this.handleMindxSelection();
                    else if (normalizedText.includes('ciberseguridad') || normalizedText.includes('biometrix')) this.handleOtherProducts(text);
                    else this.showInvalidOption();
                    break;
                case 'ASK_QUOTE':
                    if (['si', 's√≠', 'cotizar', 'yes', 'claro'].includes(normalizedText)) this.askForName();
                    else if (['no', 'explorar', 'soloexplorar'].includes(normalizedText)) this.startExplorerMode();
                    else this.showInvalidOption();
                    break;
                case 'COLLECT_NAME': this.leadData.name = text; this.askForPhone(); break;
                case 'COLLECT_PHONE': this.leadData.phone = text; this.askForCompany(); break;
                case 'COLLECT_COMPANY': this.leadData.company = text; this.askForEmail(); break;
                case 'COLLECT_EMAIL':
                    if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(text)) {
                        this.leadData.email = text;
                        await this.addMessage(`<p>¬°Gracias! Hemos recibido tus datos. En breve recibir√°s la informaci√≥n en <strong>${this.leadData.email}</strong>.</p>`);
                        this.transitionToCalculator();
                    } else {
                        await this.addMessage(`<p>El formato del correo no parece v√°lido. Por favor, ingr√©salo de nuevo.</p>`);
                    }
                    break;
                case 'CALCULATOR_FLOW': this.handleCalculatorInput(normalizedText); break;
            }
        }
        
        // ... (El resto de las funciones de flujo inicial se mantienen igual) ...
        handleCalculatorInput(normalizedText) {const options = this.getCurrentCalculatorOptions(); const matchedOption = Object.keys(options).find(key => normalizedText.includes(key)); if (matchedOption) { options[matchedOption](); } else { this.addMessage(`<p>No he entendido tu respuesta. Por favor, usa los botones o escribe una de las opciones mostradas.</p>`); }}
        getCurrentCalculatorOptions() {const options = {}; const allButtons = this.messagesContainer.querySelectorAll('.option-button, .continue-button'); allButtons.forEach(btn => { let key = (btn.dataset.channel || btn.dataset.package?.split('-')[4] || btn.innerText).toLowerCase().replace(/[^a-z0-9]/g, ''); if (key) options[key] = () => btn.click(); }); return options;}
        async showInvalidOption() {await this.addMessage('<p>No he entendido tu respuesta. Por favor, elige una de las opciones disponibles.</p>');}
        async askProduct() {await this.addMessage(`<p>¬°Hola! üëã Soy tu asistente virtual de AXD.</p><p>Para ayudarte mejor, ¬øen qu√© tipo de producto est√°s interesado?</p><div class="button-options"><button class="option-button" onclick="window.calculator.handleMindxSelection()">ü§ñ MindX</button><button class="option-button" onclick="window.calculator.handleOtherProducts('Ciberseguridad')">üõ°Ô∏è Ciberseguridad</button><button class="option-button" onclick="window.calculator.handleOtherProducts('Biometrix')">üë§ Biometrix</button></div>`);}
        async handleMindxSelection() {this.flowState = 'ASK_QUOTE'; await this.addMessage('<p>ü§ñ Has seleccionado <strong>MindX</strong>.</p>', true); await this.addMessage(`<p>¬°Genial! Con MindX puedes automatizar conversaciones o simplemente explorar sus capacidades.</p><p>¬øQu√© te gustar√≠a hacer?</p><div class="button-options"><button class="option-button" onclick="window.calculator.askForName()">‚úÖ ¬°S√≠, cotizar!</button><button class="option-button" onclick="window.calculator.startExplorerMode()">üöÄ S√≥lo explorar</button></div>`);}
        async handleOtherProducts(product) {this.isFinished = true; await this.addMessage(`<p>Has seleccionado <strong>${product}</strong>.</p>`, true); await this.addMessage(`<p>¬°Excelente elecci√≥n! Para darte informaci√≥n detallada sobre <strong>${product}</strong>, uno de nuestros especialistas se pondr√° en contacto contigo.</p><p>Gracias por tu inter√©s en AXD.</p>`);}
        async startExplorerMode() {await this.addMessage('<p>üöÄ S√≥lo explorar</p>', true); await this.addMessage(`<p>¬°Perfecto! Vamos a explorar las opciones del cotizador.</p>`); this.transitionToCalculator();}
        async askForName() {this.flowState = 'COLLECT_NAME'; await this.addMessage('<p>‚úÖ ¬°S√≠, cotizar!</p>', true); await this.addMessage('<p>Estupendo. Para generar tu cotizaci√≥n formal, por favor dime tu <strong>nombre completo</strong>.</p>');}
        async askForPhone() {this.flowState = 'COLLECT_PHONE'; await this.addMessage('<p>Gracias. Ahora, por favor, ind√≠came tu <strong>n√∫mero de tel√©fono</strong>.</p>');}
        async askForCompany() {this.flowState = 'COLLECT_COMPANY'; await this.addMessage('<p>¬°Genial! ¬øCu√°l es el <strong>nombre de tu empresa</strong>?</p>');}
        async askForEmail() {this.flowState = 'COLLECT_EMAIL'; await this.addMessage('<p>Casi terminamos. Por favor, proporciona tu <strong>correo electr√≥nico</strong> donde enviaremos la cotizaci√≥n.</p>');}
        async endConversation() {this.isFinished = true; await this.addMessage('<p>Entendido. Si cambias de opini√≥n, estar√© aqu√≠ para ayudarte. ¬°Que tengas un buen d√≠a!</p>');}
        async transitionToCalculator() {this.flowState = 'CALCULATOR_FLOW'; this.chatTitle.innerText = 'Calculadora de Costos IA'; await this.addMessage(`<p>Ahora comencemos a configurar tu soluci√≥n <strong>MindX</strong>. üöÄ</p>`); this.startCalculatorFlow();}
        
        // --- INICIO: C√ìDIGO DEL COTIZADOR ORIGINAL (Funciones intactas) ---
        
        async startCalculatorFlow() {
            this.updateProgress();
            await this.addMessage(`
                <p>Este cotizador te guiar√° paso a paso.</p>
                <p>¬øEst√°s listo para comenzar? üöÄ</p>
                <div class="button-options">
                    <button class="option-button" onclick="window.calculator.nextStep()">¬°S√≠, comencemos! üéØ</button>
                </div>
            `);
        }

        updateProgress() {
            const progress = this.flowState === 'CALCULATOR_FLOW' ? ((this.step) / this.totalSteps) * 100 : 0;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }
        
        async addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            const avatarContent = isUser ? 'üë§' : '<img src="https://cdn3d.iconscout.com/3d/premium/thumb/asistente-robot-8137090-6617492.png" alt="MindX AI" />';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-content">${content}</div>`;

            this.messagesContainer.appendChild(messageDiv);
            this.scrollToBottom();
            
            if (!isUser) {
                await new Promise(resolve => setTimeout(resolve, 400));
            }
            return messageDiv;
        }

        scrollToBottom() {
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }

        formatCurrency(value, currency = 'USD') {
            const options = { style: 'currency', currency, minimumFractionDigits: 2 };
            if (currency === 'COP') {
                options.minimumFractionDigits = 0;
                options.maximumFractionDigits = 0;
            }
            return new Intl.NumberFormat('es-CO', options).format(value);
        }

        async nextStep() {
            this.step++;
            this.updateProgress();
            switch(this.step) {
                case 1: await this.stepChannels(); break;
                case 2: await this.stepPackages(); break;
                case 3: await this.stepInsights(); break;
                case 4: await this.stepAgents(); break;
                case 5: await this.stepAI(); break;
                case 6: await this.stepNotifications(); break;
                case 7: await this.stepImplementation(); break; // <-- ESTA FUNCI√ìN SE MODIFICA
                case 8: await this.stepSummary(); break;
            }
        }
        
        // --- INICIO: FUNCI√ìN DE IMPLEMENTACI√ìN ACTUALIZADA ---
        async stepImplementation() {
            await this.addMessage(`
                <p><strong>Paquete de Implementaci√≥n</strong> üõ†Ô∏è</p>
                <p>Elige el tipo de implementaci√≥n que mejor se ajuste a tus necesidades. Este es un pago √∫nico para el dise√±o, desarrollo y despliegue de tu soluci√≥n.</p>
                <div class="implementation-cards">
                    
                    <div class="implementation-card" data-impl="A-1400-40-B√°sico" onclick="window.calculator.selectImplementation(this)">
                        <div>
                            <div class="card-icon">üîÑ</div>
                            <div class="card-title">TIPO A</div>
                            <div class="card-subtitle">Flujos B√°sicos</div>
                            <div class="card-price">$1,400 USD</div>
                            <div class="card-hours">40 horas incluidas</div>
                        </div>
                        <ul class="card-features">
                            <li><i class="fas fa-check-circle"></i> Navegaci√≥n por botones</li>
                            <li><i class="fas fa-check-circle"></i> Respuestas preestablecidas</li>
                            <li><i class="fas fa-check-circle"></i> Sin integraciones externas</li>
                        </ul>
                    </div>

                    <div class="implementation-card" data-impl="B-2800-80-Intermedio" onclick="window.calculator.selectImplementation(this)">
                        <div>
                            <div class="card-icon">üîó</div>
                            <div class="card-title">TIPO B</div>
                            <div class="card-subtitle">Flujos con Integraciones</div>
                            <div class="card-price">$2,800 USD</div>
                            <div class="card-hours">80 horas incluidas</div>
                        </div>
                        <ul class="card-features">
                            <li><i class="fas fa-check-circle"></i> Consumo de APIs/Webservices</li>
                            <li><i class="fas fa-check-circle"></i> Conexi√≥n a BD/CRM</li>
                            <li><i class="fas fa-check-circle"></i> Validaciones complejas</li>
                        </ul>
                    </div>

                    <div class="implementation-card selected" data-impl="C-4200-120-Avanzado" onclick="window.calculator.selectImplementation(this)">
                        <div>
                            <div class="card-icon">ü§ñ</div>
                            <div class="card-title">TIPO C</div>
                            <div class="card-subtitle">IA Generativa</div>
                            <div class="card-price">$4,200 USD</div>
                            <div class="card-hours">120 horas incluidas</div>
                        </div>
                        <ul class="card-features">
                            <li><i class="fas fa-check-circle"></i> IA Generativa integrada</li>
                            <li><i class="fas fa-check-circle"></i> Base de conocimiento</li>
                            <li><i class="fas fa-check-circle"></i> Respuestas contextuales</li>
                        </ul>
                    </div>

                    <div class="implementation-card" data-impl="D-custom-custom-Custom" onclick="window.calculator.selectImplementation(this)">
                        <div>
                            <div class="card-icon">‚öôÔ∏è</div>
                            <div class="card-title">TIPO D</div>
                            <div class="card-subtitle">Soluci√≥n Custom</div>
                            <div class="card-price">A cotizar</div>
                            <div class="card-hours">Horas variables</div>
                        </div>
                        <ul class="card-features">
                            <li><i class="fas fa-check-circle"></i> Desarrollo a medida</li>
                            <li><i class="fas fa-check-circle"></i> Requisitos espec√≠ficos</li>
                            <li><i class="fas fa-check-circle"></i> Consultor√≠a especializada</li>
                        </ul>
                    </div>

                </div>
            `);
        }
        // --- FIN: FUNCI√ìN DE IMPLEMENTACI√ìN ACTUALIZADA ---
        
        // El resto de las funciones originales se pegan aqu√≠ para completitud
        contactSales() { window.parent.postMessage('contactSales', '*'); }
        restart() { this.isFinished = true; const newCalculator = new AICostCalculator(); window.calculator = newCalculator; }
    }

    // --- PEGADO DE FUNCIONES ORIGINALES RESTANTES DEL COTIZADOR ---
    Object.assign(AICostCalculator.prototype, {
        async stepChannels() {await this.addMessage(`<p><strong>Canales digitales</strong> üì±</p><p>üí∞ <span style="color: #d4af37;">Primer canal GRATUITO</span>. Adicionales: $100 USD/mes c/u.</p><p>¬øCu√°les necesitas?</p><div class="button-options"><button class="option-button" data-channel="whatsapp" onclick="window.calculator.toggleChannel(this)">üì± WhatsApp</button><button class="option-button" data-channel="telegram" onclick="window.calculator.toggleChannel(this)">‚úàÔ∏è Telegram</button><button class="option-button" data-channel="facebook" onclick="window.calculator.toggleChannel(this)">üìò Messenger</button><button class="option-button" data-channel="instagram" onclick="window.calculator.toggleChannel(this)">üì∑ Instagram</button><button class="option-button" data-channel="webchat" onclick="window.calculator.toggleChannel(this)">üí¨ WebChat</button></div><button class="continue-button" onclick="window.calculator.channelsContinue()" style="display: none;">Continuar ‚û°</button>`);},
        toggleChannel(button) {const channel = button.dataset.channel;button.classList.toggle('selected');if (button.classList.contains('selected')) {if (!this.data.channels.includes(channel)) this.data.channels.push(channel);} else {this.data.channels = this.data.channels.filter(c => c !== channel);}this.calculateChannelCosts();const continueBtn = button.parentElement.parentElement.querySelector('.continue-button');if(continueBtn) continueBtn.style.display = this.data.channels.length > 0 ? 'block' : 'none';},
        calculateChannelCosts() {const channelsCount = this.data.channels.length;this.costs.channels = channelsCount > 0 ? (channelsCount - 1) * 100 : 0;},
        async channelsContinue() {const channelNames = { whatsapp: 'WhatsApp', telegram: 'Telegram', facebook: 'Facebook Messenger', instagram: 'Instagram Direct', webchat: 'WebChat' };const selectedNames = this.data.channels.map(c => channelNames[c]).join(', ');await this.addMessage(`<p>‚úÖ Seleccionados: <strong>${selectedNames}</strong></p><div class="cost-display"><strong>Canales:</strong> ${this.data.channels.length}<br><strong>Costo:</strong> ${this.formatCurrency(this.costs.channels)} USD/mes${this.data.channels.length > 0 ? '<br><small>(Primer canal gratis)</small>' : ''}</div>`, true);await this.nextStep();},
        async stepPackages() {await this.addMessage(`<p><strong>Paquete de conversaciones</strong> üìä</p><p>Incluye licencias MindX Insights para an√°lisis.</p><div class="button-options"><button class="option-button" data-package="3500-283-1-0.075-B√°sico" onclick="window.calculator.selectPackage(this)">üì¶ B√°sico<br><small>3.5K conv - $283</small></button><button class="option-button" data-package="5500-343-1-0.059-Est√°ndar" onclick="window.calculator.selectPackage(this)">üìä Est√°ndar<br><small>5.5K conv - $343</small></button><button class="option-button" data-package="8500-453-2-0.049-Profesional" onclick="window.calculator.selectPackage(this)">üöÄ Profesional<br><small>8.5K conv - $453</small></button><button class="option-button" data-package="10000-510-2-0.047-Empresarial" onclick="window.calculator.selectPackage(this)">üè¢ Empresarial<br><small>10K conv - $510</small></button></div>`);},
        async selectPackage(button) {button.parentElement.querySelectorAll('.option-button').forEach(btn =>btn.classList.remove('selected'));button.classList.add('selected');const [conversations, price, licenses, additionalCost, name] = button.dataset.package.split('-');this.data.package = {conversations: parseInt(conversations),price: parseFloat(price),licenses: parseInt(licenses),additionalCost: parseFloat(additionalCost),name: name};this.costs.package = this.data.package.price;await this.addMessage(`<p>‚úÖ Paquete <strong>${name}</strong> seleccionado</p><div class="cost-display"><strong>Conversaciones:</strong> ${conversations}<br><strong>Licencias:</strong> ${licenses}<br><strong>Costo:</strong> ${this.formatCurrency(parseFloat(price))} USD/mes</div><p>¬øConversaciones adicionales? (${this.formatCurrency(parseFloat(additionalCost))} c/u)</p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeQuantity('additionalConversations', -100)">-</button><span class="quantity-display" id="additionalConversations">0</span><button class="quantity-btn" onclick="window.calculator.changeQuantity('additionalConversations', 100)">+</button><span style="margin-left: 5px; color: #666; font-size: 0.75rem;">adicionales</span></div><button class="continue-button" onclick="window.calculator.packagesContinue()">Continuar ‚û°</button>`, true);},
        changeQuantity(field, change) {this.data[field] = Math.max(0, (this.data[field] || 0) + change);const element = document.getElementById(field);if (element) {element.textContent = this.data[field];}if (field === 'additionalConversations' && this.data.package) {this.costs.package = this.data.package.price +(this.data.additionalConversations * this.data.package.additionalCost);} else if (field === 'additionalInsights') {this.updateInsightsCost();} else if (field === 'agentLicenses') {this.updateAgentsCost();}},
        async packagesContinue() {const totalConversations = this.data.package.conversations + this.data.additionalConversations;await this.addMessage(`<div class="cost-display"><strong>Total conversaciones:</strong> ${totalConversations.toLocaleString('es-CO')}<br><strong>Costo total:</strong> ${this.formatCurrency(this.costs.package)} USD/mes</div>`, true);await this.nextStep();},
        async stepInsights() {await this.addMessage(`<p><strong>Licencias MindX Insights adicionales</strong> üìà</p><p>Incluidas: <strong>${this.data.package.licenses}</strong>. Adicionales: $20 USD/mes c/u.</p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeQuantity('additionalInsights', -1)">-</button><span class="quantity-display" id="additionalInsights">0</span><button class="quantity-btn" onclick="window.calculator.changeQuantity('additionalInsights', 1)">+</button><span style="margin-left: 5px; color: #666; font-size: 0.75rem;">adicionales</span></div><div class="cost-display" id="insightsCost"><strong>Costo adicional:</strong> ${this.formatCurrency(0)} USD/mes</div><button class="continue-button" onclick="window.calculator.insightsContinue()">Continuar ‚û°</button>`);this.updateInsightsCost();},
        updateInsightsCost() {this.costs.insights = this.data.additionalInsights * 20;const costDisplay = document.getElementById('insightsCost');if (costDisplay) {costDisplay.innerHTML = `<strong>Costo adicional:</strong> ${this.formatCurrency(this.costs.insights)} USD/mes`;}},
        async insightsContinue() {const totalLicenses = this.data.package.licenses + this.data.additionalInsights;await this.addMessage(`<div class="cost-display"><strong>Total licencias:</strong> ${totalLicenses}<br><strong>Costo adicional:</strong> ${this.formatCurrency(this.costs.insights)} USD/mes</div>`, true);await this.nextStep();},
        async stepAgents() {await this.addMessage(`<p><strong>Licencias Agentes MindX</strong> üë•</p><p>Para atenci√≥n humana. $20 USD/mes c/u.</p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeQuantity('agentLicenses', -1)">-</button><span class="quantity-display" id="agentLicenses">0</span><button class="quantity-btn" onclick="window.calculator.changeQuantity('agentLicenses', 1)">+</button><span style="margin-left: 5px; color: #666; font-size: 0.75rem;">licencias</span></div><div class="cost-display" id="agentsCost"><strong>Costo:</strong> ${this.formatCurrency(0)} USD/mes</div><button class="continue-button" onclick="window.calculator.agentsContinue()">Continuar ‚û°</button>`);this.updateAgentsCost();},
        updateAgentsCost() {this.costs.agents = this.data.agentLicenses * 20;const costDisplay = document.getElementById('agentsCost');if (costDisplay) {costDisplay.innerHTML = `<strong>Costo:</strong> ${this.formatCurrency(this.costs.agents)} USD/mes`;}},
        async agentsContinue() {await this.addMessage(`<div class="cost-display"><strong>Licencias agentes:</strong> ${this.data.agentLicenses}<br><strong>Costo:</strong> ${this.formatCurrency(this.costs.agents)} USD/mes</div>`, true);await this.nextStep();},
        async stepAI() {await this.addMessage(`<p><strong>IA Generativa</strong> ü§ñ</p><p>Respuestas naturales, consulta bases de conocimiento, etc.</p><div class="button-options"><button class="option-button" onclick="window.calculator.selectAI(true)">‚úÖ Incluir IA</button><button class="option-button" onclick="window.calculator.selectAI(false)">‚ùå No incluir</button></div>`);},
        async selectAI(include) {this.data.includeAI = include;if (include) {await this.addMessage(`<p>üéâ ¬°Excelente! Configuremos la IA:</p><p><strong>Tama√±o archivo (MB):</strong></p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeAIConfig('fileSize', -10)">-</button><span class="quantity-display" id="fileSize">100</span><button class="quantity-btn" onclick="window.calculator.changeAIConfig('fileSize', 10)">+</button></div><p><strong>Frecuencia actualizaci√≥n:</strong></p><div class="button-options"><button class="option-button" data-freq="12" onclick="window.calculator.selectUpdateFreq(this)">üìÖ Mensual</button><button class="option-button" data-freq="4" onclick="window.calculator.selectUpdateFreq(this)">üìä Trimestral</button><button class="option-button" data-freq="2" onclick="window.calculator.selectUpdateFreq(this)">üìà Semestral</button></div><p><strong>Mensajes IA/conversaci√≥n:</strong></p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeAIConfig('messagesPerConv', -1)">-</button><span class="quantity-display" id="messagesPerConv">3</span><button class="quantity-btn" onclick="window.calculator.changeAIConfig('messagesPerConv', 1)">+</button></div><button class="continue-button" onclick="window.calculator.aiContinue()" style="display: none;">Continuar ‚û°</button>`, true);this.data.aiConfig = {fileSize: 100,updateFreq: 12,messagesPerConv: 3};} else {await this.addMessage(`<div class="cost-display"><strong>IA Generativa:</strong> No incluida</div>`, true);await this.nextStep();}},
        changeAIConfig(field, change) {this.data.aiConfig[field] = Math.max(1, (this.data.aiConfig[field] || 0) + change);const element = document.getElementById(field);if (element) {element.textContent = this.data.aiConfig[field];}this.calculateAICosts();},
        selectUpdateFreq(button) {button.parentElement.querySelectorAll('.option-button').forEach(btn =>btn.classList.remove('selected'));button.classList.add('selected');this.data.aiConfig.updateFreq = parseInt(button.dataset.freq);this.calculateAICosts();const continueBtn = button.parentElement.parentElement.querySelector('.continue-button');if (continueBtn) {continueBtn.style.display = 'block';}},
        calculateAICosts() {if (!this.data.includeAI) {this.costs.ai = { loading: 0, storage: 0, usage: 0, monthly: 0 };return;}const { fileSize, updateFreq, messagesPerConv } = this.data.aiConfig;const totalConversations = this.data.package.conversations + this.data.additionalConversations;this.costs.ai.loading = fileSize * 0.093 * updateFreq;const storageGB = (fileSize / 1000) * 1.7;this.costs.ai.storage = storageGB * 0.1 * 30;const totalAIMessages = totalConversations * messagesPerConv;this.costs.ai.usage = (totalAIMessages / 20000) * 111;this.costs.ai.monthly = this.costs.ai.storage + this.costs.ai.usage;},
        async aiContinue() {this.calculateAICosts();await this.addMessage(`<div class="cost-display"><strong>Archivo:</strong> ${this.data.aiConfig.fileSize} MB<br><strong>Carga inicial:</strong> ${this.formatCurrency(this.costs.ai.loading)} USD<br><strong>Costo mensual:</strong> ${this.formatCurrency(this.costs.ai.monthly)} USD</div>`, true);await this.nextStep();},
        async stepNotifications() {await this.addMessage(`<p><strong>Notificaciones WhatsApp</strong> üì¢</p><p>Para env√≠o de plantillas (marketing, confirmaciones, etc.)</p><div class="button-options"><button class="option-button" onclick="window.calculator.selectNotifications(true)">‚úÖ Incluir</button><button class="option-button" onclick="window.calculator.selectNotifications(false)">‚ùå No incluir</button></div>`);},
        async selectNotifications(include) {if (include) {await this.addMessage(`<p>üì± Configuremos notificaciones mensuales:</p><p><strong>Marketing ($0.015 c/u):</strong></p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeNotification('marketing', -100)">-</button><span class="quantity-display" id="marketing">0</span><button class="quantity-btn" onclick="window.calculator.changeNotification('marketing', 100)">+</button></div><p><strong>Utility ($0.0024 c/u):</strong></p><div class="quantity-selector"><button class="quantity-btn" onclick="window.calculator.changeNotification('utility', -100)">-</button><span class="quantity-display" id="utility">0</span><button class="quantity-btn" onclick="window.calculator.changeNotification('utility', 100)">+</button></div><div class="cost-display" id="notificationsCost"><strong>Costo:</strong> ${this.formatCurrency(0)} USD/mes</div><button class="continue-button" onclick="window.calculator.notificationsContinue()">Continuar ‚û°</button>`, true);} else {this.costs.notifications = 0;await this.addMessage(`<div class="cost-display"><strong>Notificaciones:</strong> No incluidas</div>`, true);await this.nextStep();}},
        changeNotification(type, change) {this.data.notifications[type] = Math.max(0, this.data.notifications[type] + change);const element = document.getElementById(type);if (element) {element.textContent = this.data.notifications[type];}this.calculateNotificationCosts();},
        calculateNotificationCosts() {const prices = { marketing: 0.0150, utility: 0.0024, authentication: 0.0092 };this.costs.notifications =(this.data.notifications.marketing * prices.marketing) +(this.data.notifications.utility * prices.utility) +(this.data.notifications.authentication || 0 * prices.authentication);const costDisplay = document.getElementById('notificationsCost');if (costDisplay) {const total = this.data.notifications.marketing + this.data.notifications.utility;costDisplay.innerHTML = `<strong>Total:</strong> ${total.toLocaleString('es-CO')}<br><strong>Costo:</strong> ${this.formatCurrency(this.costs.notifications)} USD/mes`;}},
        async notificationsContinue() {const total = this.data.notifications.marketing + this.data.notifications.utility;await this.addMessage(`<div class="cost-display"><strong>Notificaciones:</strong> ${total.toLocaleString('es-CO')}/mes<br><strong>Costo:</strong> ${this.formatCurrency(this.costs.notifications)} USD/mes</div>`, true);await this.nextStep();},
        selectImplementation(card) {card.parentElement.querySelectorAll('.implementation-card').forEach(c =>c.classList.remove('selected'));card.classList.add('selected');const [type, cost, hours, name] = card.dataset.impl.split('-');if (type === 'D') {this.data.implementation = { type, cost: 2800, hours: 80, name: 'Custom' };this.costs.implementation = 2800;} else {this.data.implementation = { type, cost: parseFloat(cost), hours: parseInt(hours), name };this.costs.implementation = parseFloat(cost);}this.implementationContinue();},
        async implementationContinue() {await this.addMessage(`<div class="cost-display"><strong>Implementaci√≥n:</strong> ${this.data.implementation.name}<br><strong>Horas:</strong> ${this.data.implementation.hours}<br><strong>Costo:</strong> ${this.formatCurrency(this.costs.implementation)} USD</div>`, true);await this.nextStep();},
        async stepSummary() {const monthlyRecurrent = this.costs.channels + this.costs.package + this.costs.insights +this.costs.agents + this.costs.ai.monthly + this.costs.notifications;const oneTime = this.costs.implementation + this.costs.ai.loading;const annualTotal = (monthlyRecurrent * 12) + oneTime;await this.addMessage(`<p>üéâ <strong>Tu cotizaci√≥n personalizada:</strong></p><div class="summary-table"><div class="summary-row"><span>üí¨ Canales</span><span>${this.formatCurrency(this.costs.channels)}</span></div><div class="summary-row"><span>üì¶ ${this.data.package.name}</span><span>${this.formatCurrency(this.costs.package)}</span></div><div class="summary-row"><span>üìà Insights</span><span>${this.formatCurrency(this.costs.insights)}</span></div><div class="summary-row"><span>üë• Agentes</span><span>${this.formatCurrency(this.costs.agents)}</span></div><div class="summary-row"><span>ü§ñ IA</span><span>${this.formatCurrency(this.costs.ai.monthly)}</span></div><div class="summary-row"><span>üì¢ Notificaciones</span><span>${this.formatCurrency(this.costs.notifications)}</span></div><div class="summary-row"><span><strong>üí∞ MENSUAL</strong></span><span><strong>${this.formatCurrency(monthlyRecurrent)}</strong></span></div></div><div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #2c2c2c, #3a3a3a); color: white; border-radius: 12px; text-align: center;"><div style="color: #d4af37; font-size: 0.9rem; margin-bottom: 5px;">üéØ INVERSI√ìN PRIMER A√ëO</div><div style="font-size: 1.5rem; font-weight: 700; color: #d4af37;">${this.formatCurrency(annualTotal)} USD</div><div style="font-size: 1rem; margin-top: 5px; opacity: 0.9;">${this.formatCurrency(annualTotal * this.data.trm, 'COP')} COP</div><small style="display: block; margin-top: 5px; opacity: 0.7;">TRM: ${this.data.trm}</small></div><div class="button-options" style="margin-top: 15px; justify-content: center;"><button class="option-button" onclick="window.calculator.contactSales()" style="background: linear-gradient(135deg, #d4af37, #b8941f); color: white;">üìû Contactar</button><button class="option-button" onclick="window.calculator.restart()" style="background: linear-gradient(135deg, #2c2c2c, #3a3a3a); color: white;">üîÑ Nueva</button></div><div style="margin-top: 15px; padding: 10px; background: #fffbe6; border-radius: 8px; border-left: 3px solid #d4af37;"><p style="margin: 0; color: #2c2c2c; font-size: 0.75rem;"><strong>üìã Notas:</strong> Precios USD ‚Ä¢ SaaS exento IVA ‚Ä¢ Soporte 24/7 incluido</p></div>`);this.isFinished = true;}
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        window.calculator = new AICostCalculator();
        setTimeout(() => {
            if (!modalOverlay.classList.contains('visible')) {
                proactiveMessage.classList.add('visible');
            }
        }, 4000);
    });
    </script>
</body>
</html>
